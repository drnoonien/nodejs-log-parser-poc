import { EventLine } from './event-mapper'
import { MockedLineReader } from './line-reader'
import { LogParser, ParserError, ParserErrors } from './log-parser'

describe(LogParser.name, () => {

    it(`expects the first event to be COMBAT_LOG_VERSION`, async () => {
        const parser = new LogParser(new MockedLineReader(
            [
                `Incorrect first line, expected the next line to be the first one`,
                '7/13 19:45:07.057  COMBAT_LOG_VERSION,19,ADVANCED_LOG_ENABLED,1,BUILD_VERSION,9.2.5,PROJECT_ID,1',
            ]
        ))

        try {
            expect.assertions(1)
            parser.streamSync('', () => null)
        } catch (error: unknown) {
            if (error instanceof ParserError) {
                expect(error.message).toBe(ParserErrors.INVALID_START_OF_FILE.message)
            }
        }
    })

    it('throws if it finds unexpected arg counts', async () => {
        const parser = new LogParser(new MockedLineReader(
            [
                '7/13 19:45:07.057  COMBAT_LOG_VERSION,19,ADVANCED_LOG_ENABLED,1,BUILD_VERSION,9.2.5,PROJECT_ID,1',
                '7/13 19:45:07.057  MAP_CHANGE,2051',
                '7/13 19:45:07.057  ZONE_CHANGE,2481,"Sepulcher of the First Ones",16',
            ]
        ))

        try {
            expect.assertions(1)
            parser.streamSync('', () => null)
        } catch (error: unknown) {
            if (error instanceof ParserError) {
                expect(error.message).toBe(ParserErrors.INVALID_ARG_COUNT.message([8], 3))
            }
        }
    })

    it('handles random sample of events', async () => {
        const parser = new LogParser(new MockedLineReader(
            [
                '7/13 19:45:07.057  COMBAT_LOG_VERSION,19,ADVANCED_LOG_ENABLED,1,BUILD_VERSION,9.2.5,PROJECT_ID,1',
                '7/31 19:39:35.921  ENCOUNTER_START,2398,"Shriekwing",16,20,2296',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-08EB431A,0,263,372,3767,2555,0,0,0,218,218,218,93,0,1120,1120,1120,30,982,275,275,275,519,258,(193195,64129,109142,263716,155271,200174,345218),(0,213602,341167,211522),[4,4,[],[(1128),(1122),(1123),(1124),(1126),(1129),(1135),(1136),(1819),(1821),(1823),(1824)],[(283,278),(107,278),(72,278),(113,278),(114,278),(69,278)]],[(173245,291,(),(6982,6649,6648,6935,8156,7882,1588),(173128,120)),(137535,272,(),(6652,7580,7749,7798,3151,6646),(173128,120)),(188879,285,(),(7187,6652,8152,1505,6646),()),(0,0,(),(),()),(188875,278,(6230,6225,0),(7359,6652,8153,7772,1498,6646),()),(173248,291,(),(8126,7882,8156,6649,6648,1588,6935),(173128,120)),(188878,278,(),(7772,8116,6652,7359,8155,1498),()),(189823,278,(),(7187,8132,8137,6652,1524,6646),()),(188876,278,(6220,0,0),(7800,8138,6652,7580,7359,1498),(173128,120)),(188881,278,(),(8117,6652,7187,8095,8154,1498),()),(179355,272,(6166,0,0),(7359,6652,7798,1586,6646,7580),(173128,120)),(189839,252,(6166,0,0),(7189,6652,7580,1498,6646),(173128,120)),(178708,278,(),(7786,7359,6652,1592,6646,6917),()),(178809,278,(),(7786,7359,6652,1592,6646),()),(188882,278,(6203,0,0),(7800,8138,6652,7359,1498),()),(189852,285,(6228,6188,0),(7187,6652,1524,6646),()),(189860,285,(),(7187,6652,1524,6646),()),(0,0,(),(),())],[Player-1305-08EB431A,21562,Player-1305-08EB431A,308488,Player-1305-08EB431A,367405,Player-1305-08EB431A,307185,Player-1305-08EB431A,368845],84,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-0A579F87,0,168,347,4162,2500,0,0,0,562,562,562,0,0,985,985,985,81,766,368,368,368,514,266,(264078,205145,108416,267170,6789,111898,267215),(0,212628,221711,212295),[2,3,[],[(824),(832),(834),(836),(830),(827),(837),(870),(1843),(1845),(1847),(1848)],[(222,278),(204,278),(205,278),(283,278),(206,278),(171,278)]],[(188889,278,(),(7772,8116,6652,7359,8151,1498,7580),(173130,120)),(180115,278,(),(7800,7359,6652,1592,6646,7580),(173130,120)),(188888,278,(),(7359,6652,8152,7786,1498,6646),()),(0,0,(),(),()),(188884,278,(6230,6225,0),(7772,8116,6652,7359,8153,1498),()),(173248,291,(),(8129,7882,8156,6649,6648,1588,6935),(173130,120)),(188887,278,(),(7187,6652,8155,1498,6646),()),(189823,278,(),(7187,8132,8137,6652,1524,6646),()),(189842,285,(6220,0,0),(7187,6652,8132,8138,1524,6646,7580),(173130,120)),(188890,278,(6205,0,0),(7359,6652,8154,7786,1498,6646),()),(189772,278,(6168,0,0),(7187,40,1524,6646,7580),(173130,120)),(178926,291,(6168,0,0),(7025,6649,6648,6935,8156,7882,1588),(173130,120)),(188270,278,(),(7187,6652,1524,6646),()),(188271,278,(),(6652,7187,1524,6646),()),(189815,278,(6203,0,0),(7187,8132,8138,6652,1524,6646),()),(189789,278,(6229,6188,0),(7187,6652,1524,6646),()),(0,0,(),(),()),(190611,1,(),(),())],[Player-1305-08EB431A,21562,Player-1305-0A579F87,307185,Player-1305-0A579F87,367405,Player-1305-0A579F87,308506],9,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-3674-081174A8,0,196,447,3691,2454,0,0,0,325,325,325,0,0,916,916,916,80,590,887,887,887,2082,262,(333919,117014,260878,16166,108281,117013,114050),(0,0,0,0),[4,4,[],[(1124),(1127),(1133),(1821),(1122),(1123),(1128),(1130),(1136),(1819),(1823),(1824)],[(95,278),(104,278),(283,278),(93,278),(147,265),(98,278)]],[(188923,278,(),(6652,7772,7359,8151,1498,7580),(173129,120)),(185820,272,(),(7359,40,7798,1589,6646,7580),(173129,120)),(188920,278,(),(6652,7359,7786,8152,1498),()),(4344,1,(),(),()),(188922,278,(6230,0,0),(7359,6652,8153,7772,1498,6646),()),(172328,291,(),(8128,7882,8156,6649,6650,1588,6935),(173128,120)),(188924,278,(),(7772,8116,6652,7359,8155,1498),()),(172323,291,(),(6992,7882,8156,6649,6650,1588),()),(178767,278,(6220,0,0),(7800,8136,8138,7359,6652,7580,1592,6646),(173129,120)),(188925,272,(),(8117,6652,7359,8154,7784,1492,6646),()),(178781,272,(6170,0,0),(7359,6652,7580,7798,1586,6646),(173129,120)),(178824,278,(6170,0,0),(7800,7359,6652,7578,1592,6646),()),(178708,272,(),(7359,6652,7784,1586,6646,6917),()),(190958,272,(),(7359,6652,7784,1589,6646),()),(178755,278,(6203,0,0),(7800,8136,8138,7359,6652,1592,6646),()),(178753,278,(6229,0,0),(7856,7359,6652,1592,6646),()),(178712,272,(),(7359,6652,7840,1586,6646),()),(0,0,(),(),())],[Player-3674-081174A8,307185,Player-3674-081174A8,308488,Player-1305-08EB431A,21562],27,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-049858B6,0,452,155,3806,2354,0,0,0,440,440,440,0,136,893,893,893,58,917,356,356,356,2647,65,(114158,183778,115750,114154,223817,248033,156910),(0,199454,199452,210294),[9,2,[],[(1546),(1547),(1548),(1554),(1559),(1872),(1876),(1549),(1551),(1552),(1877),(1874)],[(284,265),(159,265),(215,265),(194,265),(283,265),(133,265)]],[(188933,278,(),(7359,6652,7579,8151,7772,1498,6646),()),(178927,291,(),(8125,7882,8156,6649,6648,1588,6935),(173128,120)),(178697,278,(),(7786,8136,8117,7359,40,1592,6646),()),(3428,1,(),(),()),(188929,285,(6230,0,0),(7187,6652,8153,1505,6646),()),(178931,278,(),(7786,8136,8137,7359,6652,7579,1592,6646),()),(188931,278,(),(7359,6652,8155,7772,1498,6646),()),(179338,278,(6207,0,0),(7786,8136,8137,7359,6652,1592,6646),()),(178807,278,(6220,0,0),(7800,8136,8138,7359,6652,7580,1592,6646),(173128,120)),(188928,272,(6210,0,0),(8117,7784,6652,7359,8154,1492),()),(178926,291,(6166,0,0),(7128,6649,6648,6935,8156,7882,1588),(173128,120)),(178933,278,(6166,0,0),(7800,7359,41,1592,6646,7580),(173128,120)),(188270,265,(),(7188,41,1511,6646),()),(178708,272,(),(7359,6652,7784,1586,6646,6918),()),(185781,278,(6204,0,0),(7800,8136,8138,7359,6652,1595,6646),()),(178856,278,(6229,0,0),(7856,7359,6652,1592,6646),()),(178712,272,(),(7359,6652,7840,1586,6646),()),(69210,1,(),(),())],[Player-1305-049858B6,340458,Player-1305-049858B6,156910,Player-1305-08EB431A,21562],16,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-0B6D9C85,0,275,1981,3706,368,0,0,0,941,941,941,58,58,401,401,401,107,988,106,106,106,1191,254,(260309,260228,270581,260367,109215,260402,260243),(0,203129,213691,202589),[2,3,[],[(827),(824),(830),(836),(832),(834),(837),(1843),(1845),(1847),(870),(1848)],[(192,278),(140,278),(157,278),(188,278),(178,278),(173,278)]],[(189775,278,(),(7187,40,7579,8132,8116,1524,6646),()),(173145,262,(),(7960,7881),(173130,120)),(188856,272,(),(8117,7784,6652,7359,8152,1492),()),(0,0,(),(),()),(188858,272,(6230,6225,0),(7188,6652,8153,1492,6646),()),(189804,278,(),(7187,6652,7579,8132,8137,1524,6646),()),(188860,278,(),(7772,8116,6652,7359,8155,1498),()),(178796,278,(6211,0,0),(7786,8136,8137,7359,43,1592,6646),()),(172329,291,(),(7014,7882,8156,6647,6648,1588,6935),(173130,120)),(188861,278,(),(7187,42,8154,1498,6646),()),(189854,285,(6168,0,0),(7187,6652,7579,1524,6646),()),(178926,291,(6168,0,0),(8122,7882,8156,6647,6648,1588,6935),(173130,120)),(180116,278,(),(7786,7359,41,1592,6646),()),(188271,265,(),(6652,7188,1511,6646),()),(180123,278,(6203,0,0),(7800,8136,8138,7359,6652,1592,6646),()),(180112,278,(6195,6188,0),(7828,7359,6652,1592,6646),()),(0,0,(),(),()),(45581,1,(),(),())],[Player-1305-0B6D9C85,155228,Player-1305-08EB431A,21562,Player-1305-0B6D9C85,307185,Player-1305-0B6D9C85,347901],16,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-0C10939D,0,196,1905,5097,449,0,0,0,852,852,852,0,37,283,283,283,30,317,1050,1050,1050,1054,268,(115098,116841,325093,116844,280515,116847,196737),(0,0,0,0),[18,1,[],[(1834),(1379),(1380),(1381),(1415),(1831),(1832),(1408),(1412),(1418),(1416),(1836)],[(33,278),(37,278),(283,278),(59,278),(46,278),(57,278)]],[(188910,278,(),(7772,8116,6652,7359,8151,1498,7580),(173129,120)),(185820,278,(),(7800,7359,6652,1595,6646,7580),(173129,120)),(188914,278,(),(7786,8117,6652,7359,8152,1498),()),(0,0,(),(),()),(188912,278,(6214,6225,0),(7772,8116,6652,7359,8153,1498),()),(172320,291,(),(7077,7882,8156,6647,6650,1588,6935),(173129,120)),(188911,278,(),(7187,6652,8155,1498,6646),()),(188917,278,(6211,0,0),(7786,8137,6652,7359,1498),()),(185817,278,(),(7800,8136,8138,7359,6652,1595,6646,7580),(173129,120)),(188916,278,(),(7187,6652,8154,1498,6646),()),(178781,272,(6170,0,0),(7359,6652,7798,1586,6646,7580),(173129,120)),(178848,272,(6170,0,0),(7359,6652,7798,1586,6646,7580),(173129,120)),(178771,278,(),(7786,7359,6652,1592,6646),()),(179331,272,(),(7359,6652,7784,1586,6646),()),(173242,291,(6203,0,0),(8124,8156,6647,6650,7882,1588),()),(178834,278,(6229,6201,0),(7814,7359,6652,1592,6646),()),(179328,272,(6228,6200,0),(7359,41,7812,1586,6646),()),(0,0,(),(),())],[Player-1305-049858B6,53563,Player-1305-0C10939D,307185,Player-1305-0C10939D,308514,Player-1305-08EB431A,21562,Player-1305-0C10939D,347901],38,0,0,0',
                '7/31 19:39:35.921  COMBATANT_INFO,Player-1305-0B8977D1,0,194,452,3757,2475,0,0,0,395,395,395,0,30,730,730,730,51,1159,244,244,244,1888,102,(202430,252216,197492,319454,102560,202354,274281),(0,233754,209740,233750),[1,3,[],[(866),(850),(859),(863),(864),(994),(995),(1840),(1010),(1837),(1838),(1842)],[(279,265),(263,265),(271,265),(255,265),(259,265),(262,265)]],[(188847,278,(),(7772,8116,6652,7359,8151,1498,7580),(173130,120)),(189827,278,(),(7187,40,1524,6646,7580),(173130,120)),(172319,291,(),(8121,7882,8156,6648,6649,1588),()),(0,0,(),(),()),(188849,278,(6230,6225,0),(7359,6652,8153,7772,1498,6646),()),(178823,278,(),(7786,8136,8137,7359,6652,7580,1592,6646),(173130,120)),(188848,278,(),(7772,8116,6652,7359,8155,1498),()),(179352,278,(6211,0,0),(7786,8136,8137,7359,6652,1592,6646),()),(189812,278,(6220,0,0),(7187,6652,7579,8132,8138,1524,6646),()),(188853,278,(),(7187,6652,8154,1498,6646),()),(178926,291,(6168,0,0),(7088,6649,6648,6935,8156,7882,1588),(173130,120)),(178824,272,(6168,0,0),(7359,6652,7798,1586,6646,7580),(173130,120)),(178708,272,(),(7359,6652,7784,1586,6646,6918),()),(179350,272,(),(7359,6652,7784,1586,6646),()),(185781,278,(6204,0,0),(7800,8136,8138,7359,6652,1595,6646),()),(185822,278,(6229,6188,0),(7828,7359,6652,1595,6646),()),(0,0,(),(),()),(0,0,(),(),())],[Player-1305-0B8977D1,307185,Player-1305-0B8977D1,367405,Player-1305-0B8977D1,24858,Player-1305-08EB431A,21562,Player-1305-0B8977D1,308506],7,0,0,0',
                '7/31 19:39:36.045  SPELL_ENERGIZE,Player-1305-0A579F87,"Flander-Kazzak",0x514,0x0,Player-1305-0A579F87,"Flander-Kazzak",0x514,0x0,280127,"Demonbolt",0x20,Player-1305-0A579F87,0000000000000000,83240,83240,297,2500,514,0,0,50000,50000,0,-1888.17,6742.94,1735,6.0339,280,2.0000,0.0000,7,50',
                '7/31 19:39:36.045  SPELL_CAST_SUCCESS,Player-1305-0A579F87,"Flander-Kazzak",0x514,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,264178,"Demonbolt",0x24,Player-1305-0A579F87,0000000000000000,83240,83240,297,2500,514,0,0,50000,50000,1000,-1888.17,6742.94,1735,6.0339,280',
                '7/31 19:39:36.088  SPELL_AURA_REMOVED,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,321527,"Swift Patrol",0x8,BUFF',
                '7/31 19:39:36.134  SPELL_CAST_SUCCESS,Player-1305-0B6D9C85,"Saintshunt-Kazzak",0x512,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,185358,"Arcane Shot",0x40,Player-1305-0B6D9C85,0000000000000000,74120,74120,2577,368,1191,0,2,100,100,40,-1887.82,6754.40,1735,5.4607,277',
                '7/31 19:39:36.225  SPELL_CAST_SUCCESS,Player-1305-0A579F87,"Flander-Kazzak",0x514,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,111898,"Grimoire: Felguard",0x20,Player-1305-0A579F87,0000000000000000,83240,83240,297,2500,514,0,7,50,50,10,-1888.17,6742.94,1735,6.0339,280',
                '7/31 19:39:36.225  SPELL_SUMMON,Player-1305-0A579F87,"Flander-Kazzak",0x514,0x0,Creature-0-4234-2296-27007-17252-000066BE5B,"Felguard",0xa28,0x0,111898,"Grimoire: Felguard",0x20',
                '7/31 19:39:36.236  SPELL_CAST_SUCCESS,Creature-0-4234-2296-27007-17252-000066BE5B,"Felguard",0x2114,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,89766,"Axe Toss",0x1,Creature-0-4234-2296-27007-17252-000066BE5B,Player-1305-0A579F87,62430,62430,1438,2875,2056,0,3,200,200,0,-1873.63,6739.24,1735,5.7229,280',
                '7/31 19:39:36.272  SPELL_ENERGIZE,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,190984,"Wrath",0x8,Player-1305-0B8977D1,0000000000000000,75140,75140,2574,2475,1888,0,8,560,1000,0,-1881.18,6752.33,1735,5.3879,278,6.0000,0.0000,8,1000',
                '7/31 19:39:36.272  SPELL_CAST_SUCCESS,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,190984,"Wrath",0x8,Player-1305-0B8977D1,0000000000000000,75140,75140,2574,2475,1888,0,8,560,1000,0,-1881.18,6752.33,1735,5.3879,278',
                '7/31 19:39:36.272  SPELL_CAST_START,Player-1305-0B8977D1,"Findruid-Kazzak",0x514,0x0,0000000000000000,nil,0x80000000,0x80000000,190984,"Wrath",0x8',
                '7/31 19:39:36.436  SPELL_AURA_APPLIED,Player-1305-0C10939D,"Iwillspin-Kazzak",0x512,0x0,Creature-0-4234-2296-27007-164406-000066BD3E,"Shriekwing",0x10a48,0x0,121253,"Keg Smash",0x1,DEBUFF',
            ]
        ))

        const collector: EventLine[] = []

        parser.streamSync('', (eventLine) => {
            collector.push(eventLine)
        })

        expect(collector).toMatchSnapshot()
    })

})